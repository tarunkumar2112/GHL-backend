<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Bookings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { margin: 0 0 12px; }
    .hint { color: #666; margin-bottom: 16px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 10px; border: 1px solid #e5e5e5; text-align: left; vertical-align: top; }
    th { background: #fafafa; }
    button { padding: 8px 12px; border: 0; border-radius: 6px; cursor: pointer; }
    .reschedule { background: #0d6efd; color: #fff; }
    .delete { background: #dc3545; color: #fff; }
    .muted { color: #666; }
    .row-actions { display: flex; gap: 8px; }
  </style>
</head>
<body>
  <h1>My Bookings</h1>
  <div class="hint">Manage your bookings below. You can reschedule or delete an appointment.</div>
  <div id="status" class="muted">Loading...</div>
  <div id="table-wrap"></div>

  <script>
    const contactId = new URLSearchParams(location.search).get("id")
    const statusEl = document.getElementById("status")
    const tableWrap = document.getElementById("table-wrap")

    if (!contactId) {
      statusEl.textContent = "❌ Missing contact ID in URL. Try ?id=CONTACT_ID"
    } else {
      loadBookings()
    }

    async function loadBookings() {
      statusEl.textContent = "Loading..."
      tableWrap.innerHTML = ""

      try {
        const res = await fetch(`/.netlify/functions/bookings?contactId=${encodeURIComponent(contactId)}`, {
          headers: { "Accept": "application/json" },
          cache: "no-store",
        })
        const data = await res.json()

        if (!res.ok) {
          throw new Error(data.error || "Failed to load bookings")
        }

        const bookings = data.bookings || []
        if (bookings.length === 0) {
          statusEl.textContent = "No bookings found."
          return
        }

        statusEl.textContent = ""
        tableWrap.innerHTML = renderTable(bookings)
      } catch (err) {
        console.error(err)
        statusEl.textContent = "❌ Failed to load bookings."
      }
    }

    function renderTable(rows) {
      let html = `<table>
        <thead>
          <tr>
            <th>Title</th>
            <th>Status</th>
            <th>Appointment Status</th>
            <th>Address</th>
            <th>Calendar</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>`

      for (const b of rows) {
        html += `<tr>
          <td>${escapeHtml(b.title || "-")}</td>
          <td>${escapeHtml(b.status || "-")}</td>
          <td>${escapeHtml(b.appointment_status || "-")}</td>
          <td>${escapeHtml(b.address || "-")}</td>
          <td><span class="muted">${escapeHtml(b.calendar_id || "-")}</span></td>
          <td class="row-actions">
            <button class="reschedule" onclick="rescheduleBooking('${b.id}', '${b.calendar_id || ""}')">Reschedule</button>
            <button class="delete" onclick="deleteBooking('${b.id}')">Delete</button>
          </td>
        </tr>`
      }

      html += `</tbody></table>`
      return html
    }

    async function deleteBooking(id) {
      if (!confirm("Are you sure you want to delete this booking?")) return

      try {
        const res = await fetch("/.netlify/functions/bookings", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, contactId }),
        })
        const data = await res.json()
        if (!res.ok) throw new Error(data.error || "Delete failed")

        alert("✅ Booking deleted")
        await loadBookings()
      } catch (err) {
        console.error(err)
        alert("❌ Failed to delete booking")
      }
    }

    async function rescheduleBooking(oldBookingId, calendarId) {
      const startTime = prompt("Enter new start time (ISO 8601, e.g. 2025-09-01T10:00:00Z):")
      if (!startTime) return
      const endTime = prompt("Enter new end time (ISO 8601, e.g. 2025-09-01T10:30:00Z):")
      if (!endTime) return

      // 1) Create a new appointment using your existing Appointment function
      try {
        const url = new URL("https://restyle-api.netlify.app/.netlify/functions/Appointment", location.origin)
        url.searchParams.set("contactId", contactId)
        if (calendarId) url.searchParams.set("calendarId", calendarId)
        url.searchParams.set("startTime", startTime)
        url.searchParams.set("endTime", endTime)
        // optional: if you store assigned_user_id, pass it too
        // url.searchParams.set("assignedUserId", assignedUserIdValue)

        const createRes = await fetch(url.toString(), { method: "GET" })
        const createData = await createRes.json()
        if (!createRes.ok) throw new Error(createData.details || createData.error || "Failed to create new appointment")

        // 2) Delete the old booking from our DB (and from LeadConnector if you add that in the function)
        await deleteBooking(oldBookingId)
        alert("✅ Rescheduled successfully")
      } catch (err) {
        console.error(err)
        alert("❌ Reschedule failed: " + err.message)
      }
    }

    // Simple escape to avoid XSS in table cells
    function escapeHtml(str) {
      return String(str).replace(/[&<>"'`=\/]/g, s => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;",
        "'": "&#39;", "/": "&#x2F;", "`": "&#x60;", "=": "&#x3D;"
      }[s]))
    }
  </script>
</body>
</html>
