<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Bookings</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/lucide@latest"></script> <!-- icons -->
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; background: #f9fafb; }
    h1 { margin: 0 0 16px; font-size: 1.5rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
    .card { background: #fff; padding: 16px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); display: flex; flex-direction: column; justify-content: space-between; }
    .card h2 { margin: 0 0 8px; font-size: 1.2rem; color: #111827; }
    .meta { font-size: 0.9rem; color: #555; margin-bottom: 8px; }
    .actions { margin-top: auto; display: flex; gap: 8px; }
    button { flex: 1; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px; border: 0; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
    .reschedule { background: #0d6efd; color: #fff; }
    .delete { background: #dc3545; color: #fff; }
  </style>
</head>
<body>
  <h1>My Bookings</h1>
  <div id="status">Loading...</div>
  <div id="grid" class="grid"></div>

  <script>
    const contactId = new URLSearchParams(location.search).get("id")
    const statusEl = document.getElementById("status")
    const grid = document.getElementById("grid")

    if (!contactId) {
      statusEl.textContent = "❌ Missing contact ID in URL"
    } else {
      loadBookings()
    }

    async function loadBookings() {
      statusEl.textContent = "Loading..."
      grid.innerHTML = ""

      try {
        const res = await fetch(`https://restyle-api.netlify.app/.netlify/functions/bookings?contactId=${encodeURIComponent(contactId)}`)
        const data = await res.json()
        if (!res.ok) throw new Error(data.error || "Failed to fetch")

        const bookings = data.bookings || []
        if (bookings.length === 0) {
          statusEl.textContent = "No bookings found."
          return
        }

        statusEl.textContent = ""
        for (const b of bookings) {
          const card = await renderCard(b)
          grid.appendChild(card)
        }
      } catch (err) {
        console.error(err)
        statusEl.textContent = "❌ Failed to load bookings"
      }
    }

    async function renderCard(b) {
      // fetch service details
      let serviceName = "—"
      let eventTitle = "—"
      try {
        const calRes = await fetch(`https://restyle-api.netlify.app/.netlify/functions/Calendarget?id=${b.calendar_id}`)
        const calData = await calRes.json()
        if (calData.calendar) {
          serviceName = calData.calendar.name || "—"
          eventTitle = calData.calendar.eventTitle || "—"
        }
      } catch (e) { console.warn("Calendar fetch failed", e) }

      // fetch staff details
      let staffName = "—"
      if (b.assigned_user_id) {
        try {
          const staffRes = await fetch(`https://restyle-api.netlify.app/.netlify/functions/Staff?id=${b.assigned_user_id}`)
          const staffData = await staffRes.json()
          staffName = staffData.name || `${staffData.firstName || ""} ${staffData.lastName || ""}`
        } catch (e) { console.warn("Staff fetch failed", e) }
      }

      const div = document.createElement("div")
      div.className = "card"
      div.innerHTML = `
        <div>
          <h2>${escapeHtml(serviceName)}</h2>
          <div class="meta">Event: ${escapeHtml(eventTitle)}</div>
          <div class="meta">Staff: ${escapeHtml(staffName)}</div>
          <div class="meta">Status: ${escapeHtml(b.status || "-")} / ${escapeHtml(b.appointment_status || "-")}</div>
        </div>
        <div class="actions">
          <button class="reschedule" onclick="rescheduleBooking('${b.id}', '${b.calendar_id}')">
            <i data-lucide="calendar-clock"></i> Reschedule
          </button>
          <button class="delete" onclick="deleteBooking('${b.id}')">
            <i data-lucide="trash-2"></i> Delete
          </button>
        </div>
      `
      lucide.createIcons(div) // replace <i data-lucide="...">
      return div
    }

    async function deleteBooking(id) {
      if (!confirm("Are you sure you want to delete this booking?")) return
      const res = await fetch("https://restyle-api.netlify.app/.netlify/functions/bookings", {
        method: "DELETE",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id, contactId }),
      })
      if (!res.ok) {
        alert("❌ Delete failed")
        return
      }
      alert("✅ Booking deleted")
      loadBookings()
    }

    async function rescheduleBooking(id, calendarId) {
      const startTime = prompt("New start time (ISO 8601, e.g. 2025-09-01T10:00:00Z):")
      if (!startTime) return
      const endTime = prompt("New end time (ISO 8601, e.g. 2025-09-01T10:30:00Z):")
      if (!endTime) return

      const url = new URL("https://restyle-api.netlify.app/.netlify/functions/Appointment", location.origin)
      url.searchParams.set("contactId", contactId)
      url.searchParams.set("calendarId", calendarId)
      url.searchParams.set("startTime", startTime)
      url.searchParams.set("endTime", endTime)

      const createRes = await fetch(url.toString(), { method: "GET" })
      const createData = await createRes.json()
      if (!createRes.ok) {
        alert("❌ Reschedule failed")
        return
      }

      await deleteBooking(id)
      alert("✅ Rescheduled successfully")
      loadBookings()
    }

    function escapeHtml(str) {
      return String(str || "").replace(/[&<>"'`=\/]/g, s => ({
        "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;",
        "'": "&#39;", "/": "&#x2F;", "`": "&#x60;", "=": "&#x3D;"
      }[s]))
    }
  </script>
</body>
</html>
